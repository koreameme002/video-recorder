<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#7c3aed">
  <meta name="description" content="ë°±ê·¸ë¼ìš´ë“œ ë¹„ë””ì˜¤ ë…¹í™” ì•±">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Recorder">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
  
  <title>Video Recorder</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(to bottom right, #0f172a, #581c87, #0f172a);
      min-height: 100vh;
      color: white;
      overflow-x: hidden;
    }
    
    .container {
      max-width: 1024px;
      margin: 0 auto;
      padding: 1rem 1rem 6rem;
    }
    
    .header {
      text-align: center;
      margin-bottom: 2rem;
      padding-top: env(safe-area-inset-top);
    }
    
    .title {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 0.5rem;
    }
    
    .subtitle {
      color: #c4b5fd;
      font-size: 0.875rem;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(16px);
      border-radius: 1.5rem;
      padding: 1.5rem;
      margin-bottom: 1rem;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .video-container {
      aspect-ratio: 16/9;
      background: black;
      border-radius: 1rem;
      margin-bottom: 1.5rem;
      overflow: hidden;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .video-preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .placeholder {
      text-align: center;
      color: rgba(255, 255, 255, 0.5);
    }
    
    .placeholder-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }
    
    .rec-badge {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: #dc2626;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      font-weight: bold;
      animation: pulse 2s infinite;
      z-index: 10;
    }
    
    .rec-dot {
      width: 0.5rem;
      height: 0.5rem;
      background: white;
      border-radius: 50%;
    }
    
    .paused-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
    }
    
    .paused-badge {
      background: #ca8a04;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 9999px;
      font-weight: bold;
    }
    
    .button-group {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 0.75rem 2rem;
      border-radius: 0.75rem;
      font-weight: bold;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1rem;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
      -webkit-tap-highlight-color: transparent;
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn-primary {
      background: #dc2626;
      color: white;
    }
    
    .btn-primary:hover {
      background: #b91c1c;
    }
    
    .btn-pause {
      background: #ca8a04;
      color: white;
    }
    
    .btn-pause:hover {
      background: #a16207;
    }
    
    .btn-resume {
      background: #16a34a;
      color: white;
    }
    
    .btn-resume:hover {
      background: #15803d;
    }
    
    .btn-small {
      padding: 0.5rem 1rem;
      font-size: 1.25rem;
    }
    
    .btn-blue {
      background: #2563eb;
      color: white;
    }
    
    .btn-blue:hover {
      background: #1d4ed8;
    }
    
    .btn-red {
      background: #dc2626;
      color: white;
    }
    
    .btn-red:hover {
      background: #b91c1c;
    }
    
    .error {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 0.75rem;
      padding: 1rem;
      margin-bottom: 1rem;
      color: #fecaca;
      font-size: 0.875rem;
    }
    
    .video-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .video-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 0.75rem;
      padding: 0.75rem;
      display: flex;
      gap: 0.75rem;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .video-thumbnail {
      width: 100%;
      max-width: 12rem;
      height: 7rem;
      border-radius: 0.5rem;
      object-fit: cover;
      background: black;
    }
    
    .video-info {
      flex: 1;
      min-width: 150px;
    }
    
    .video-title {
      font-weight: bold;
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
    }
    
    .video-date {
      color: #c4b5fd;
      font-size: 0.75rem;
    }
    
    .video-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .hidden {
      display: none !important;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* PWA Safe Area */
    @supports(padding: max(0px)) {
      .container {
        padding-left: max(1rem, env(safe-area-inset-left));
        padding-right: max(1rem, env(safe-area-inset-right));
        padding-bottom: max(6rem, env(safe-area-inset-bottom));
      }
    }
    
    @media (max-width: 768px) {
      .title {
        font-size: 1.5rem;
      }
      
      .video-item {
        flex-direction: column;
        align-items: stretch;
      }
      
      .video-thumbnail {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 class="title">ğŸ“¹ Video Recorder</h1>
      <p class="subtitle" id="subtitle">ë°±ê·¸ë¼ìš´ë“œ ë…¹í™” ê°€ëŠ¥</p>
    </div>

    <div id="errorContainer"></div>

    <div class="card">
      <div class="video-container">
        <div id="placeholder" class="placeholder">
          <div class="placeholder-icon">ğŸ“¹</div>
          <p>ë…¹í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”</p>
        </div>
        <video id="videoPreview" class="video-preview hidden" autoplay muted playsinline></video>
        <div id="recBadge" class="rec-badge hidden">
          <div class="rec-dot"></div>
          <span id="recTime">REC 00:00:00</span>
        </div>
        <div id="pausedOverlay" class="paused-overlay hidden">
          <div class="paused-badge">ì¼ì‹œì •ì§€ë¨</div>
        </div>
      </div>

      <div class="button-group">
        <button id="startBtn" class="btn btn-primary">ğŸ¬ ë…¹í™” ì‹œì‘</button>
        <button id="pauseBtn" class="btn btn-pause hidden">â¸ï¸ ì¼ì‹œì •ì§€</button>
        <button id="resumeBtn" class="btn btn-resume hidden">â–¶ï¸ ì¬ê°œ</button>
        <button id="stopBtn" class="btn btn-primary hidden">â¹ï¸ ì •ì§€</button>
      </div>
    </div>

    <div id="videosCard" class="card hidden">
      <h2 style="font-size: 1.25rem; font-weight: bold; margin-bottom: 1rem;">
        ë…¹í™”ëœ ì˜ìƒ (<span id="videoCount">0</span>ê°œ)
      </h2>
      <div id="videoList" class="video-list"></div>
    </div>
  </div>
  
  <script>
    // Service Worker ë“±ë¡ (PWA)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('âœ… Service Worker ë“±ë¡ ì„±ê³µ:', reg.scope))
          .catch(err => console.log('âŒ Service Worker ë“±ë¡ ì‹¤íŒ¨:', err));
      });
    }

    // ìƒíƒœ ê´€ë¦¬
    const state = {
      isRecording: false,
      isPaused: false,
      recordedVideos: [],
      elapsedTime: 0,
      stream: null,
      mediaRecorder: null,
      chunks: [],
      timer: null
    };

    // DOM ìš”ì†Œ
    const elements = {
      subtitle: document.getElementById('subtitle'),
      errorContainer: document.getElementById('errorContainer'),
      placeholder: document.getElementById('placeholder'),
      videoPreview: document.getElementById('videoPreview'),
      recBadge: document.getElementById('recBadge'),
      recTime: document.getElementById('recTime'),
      pausedOverlay: document.getElementById('pausedOverlay'),
      startBtn: document.getElementById('startBtn'),
      pauseBtn: document.getElementById('pauseBtn'),
      resumeBtn: document.getElementById('resumeBtn'),
      stopBtn: document.getElementById('stopBtn'),
      videosCard: document.getElementById('videosCard'),
      videoCount: document.getElementById('videoCount'),
      videoList: document.getElementById('videoList')
    };

    // PWA ì„¤ì¹˜ í™•ì¸
    if (window.matchMedia('(display-mode: standalone)').matches || 
        window.navigator.standalone === true) {
      elements.subtitle.textContent = 'âœ… ì•±ìœ¼ë¡œ ì„¤ì¹˜ë¨';
    }

    // ì‹œê°„ í¬ë§·íŒ…
    function formatTime(seconds) {
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    // ì—ëŸ¬ í‘œì‹œ
    function showError(message) {
      let detailMessage = message;
      if (message.includes('NotAllowedError') || message.includes('Permission denied')) {
        detailMessage = `
          <strong>âŒ ì¹´ë©”ë¼/ë§ˆì´í¬ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤</strong><br><br>
          <strong>í•´ê²° ë°©ë²•:</strong><br>
          1. ì£¼ì†Œì°½ ì™¼ìª½ì˜ <strong>ğŸ”’ ìë¬¼ì‡  ì•„ì´ì½˜</strong>ì„ í´ë¦­í•˜ì„¸ìš”<br>
          2. <strong>ì¹´ë©”ë¼</strong>ì™€ <strong>ë§ˆì´í¬</strong>ë¥¼ <strong>"í—ˆìš©"</strong>ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš”<br>
          3. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”
        `;
      }
      elements.errorContainer.innerHTML = `<div class="error">${detailMessage}</div>`;
    }

    function clearError() {
      elements.errorContainer.innerHTML = '';
    }

    // UI ì—…ë°ì´íŠ¸
    function updateUI() {
      if (state.isRecording) {
        elements.placeholder.classList.add('hidden');
        elements.videoPreview.classList.remove('hidden');
        elements.recBadge.classList.remove('hidden');
        elements.startBtn.classList.add('hidden');
        elements.stopBtn.classList.remove('hidden');

        if (state.isPaused) {
          elements.pauseBtn.classList.add('hidden');
          elements.resumeBtn.classList.remove('hidden');
          elements.pausedOverlay.classList.remove('hidden');
        } else {
          elements.pauseBtn.classList.remove('hidden');
          elements.resumeBtn.classList.add('hidden');
          elements.pausedOverlay.classList.add('hidden');
        }
      } else {
        elements.placeholder.classList.remove('hidden');
        elements.videoPreview.classList.add('hidden');
        elements.recBadge.classList.add('hidden');
        elements.pausedOverlay.classList.add('hidden');
        elements.startBtn.classList.remove('hidden');
        elements.pauseBtn.classList.add('hidden');
        elements.resumeBtn.classList.add('hidden');
        elements.stopBtn.classList.add('hidden');
      }

      if (state.recordedVideos.length > 0) {
        elements.videosCard.classList.remove('hidden');
        elements.videoCount.textContent = state.recordedVideos.length;
      }
    }

    // ë…¹í™” ì‹œì‘
    async function startRecording() {
      try {
        clearError();
        console.log('ğŸ¬ ë…¹í™” ì‹œì‘...');

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showError('ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ ë…¹í™”ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          return;
        }

        state.stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
          audio: true
        });
        
        console.log('âœ… ì¹´ë©”ë¼ ê¶Œí•œ íšë“!');

        elements.videoPreview.srcObject = state.stream;

        let mimeType = 'video/webm';
        if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')) {
          mimeType = 'video/webm;codecs=vp9';
        } else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp8')) {
          mimeType = 'video/webm;codecs=vp8';
        }

        state.mediaRecorder = new MediaRecorder(state.stream, { mimeType });
        state.chunks = [];

        state.mediaRecorder.ondataavailable = (e) => {
          if (e.data && e.data.size > 0) {
            state.chunks.push(e.data);
          }
        };

        state.mediaRecorder.onstop = () => {
          const blob = new Blob(state.chunks, { type: mimeType });
          const url = URL.createObjectURL(blob);
          const newVideo = {
            id: Date.now(),
            url,
            blob,
            duration: state.elapsedTime,
            timestamp: new Date().toLocaleString('ko-KR')
          };
          state.recordedVideos.unshift(newVideo);
          state.chunks = [];
          renderVideoList();
        };

        state.mediaRecorder.start(100);
        state.isRecording = true;
        state.elapsedTime = 0;

        state.timer = setInterval(() => {
          state.elapsedTime++;
          elements.recTime.textContent = `REC ${formatTime(state.elapsedTime)}`;
        }, 1000);

        updateUI();
      } catch (err) {
        console.error('âŒ ë…¹í™” ì˜¤ë¥˜:', err);
        
        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
          showError('NotAllowedError: Permission denied');
        } else if (err.name === 'NotFoundError') {
          showError('<strong>âŒ ì¹´ë©”ë¼ ë˜ëŠ” ë§ˆì´í¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</strong>');
        } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') {
          showError('<strong>âŒ ì¹´ë©”ë¼ê°€ ì´ë¯¸ ë‹¤ë¥¸ ì•±ì—ì„œ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤</strong>');
        } else {
          showError(`ì˜¤ë¥˜: ${err.name} - ${err.message}`);
        }
      }
    }

    // ì¼ì‹œì •ì§€
    function pauseRecording() {
      if (state.mediaRecorder?.state === 'recording') {
        state.mediaRecorder.pause();
        state.isPaused = true;
        clearInterval(state.timer);
        updateUI();
      }
    }

    // ì¬ê°œ
    function resumeRecording() {
      if (state.mediaRecorder?.state === 'paused') {
        state.mediaRecorder.resume();
        state.isPaused = false;
        state.timer = setInterval(() => {
          state.elapsedTime++;
          elements.recTime.textContent = `REC ${formatTime(state.elapsedTime)}`;
        }, 1000);
        updateUI();
      }
    }

    // ì •ì§€
    function stopRecording() {
      if (state.mediaRecorder?.state !== 'inactive') {
        state.mediaRecorder.stop();
        state.isRecording = false;
        state.isPaused = false;
        clearInterval(state.timer);

        if (state.stream) {
          state.stream.getTracks().forEach(track => track.stop());
          state.stream = null;
        }

        elements.videoPreview.srcObject = null;
        updateUI();
      }
    }

    // ë¹„ë””ì˜¤ ëª©ë¡ ë Œë”ë§
    function renderVideoList() {
      elements.videoList.innerHTML = state.recordedVideos.map(video => `
        <div class="video-item">
          <video src="${video.url}" controls class="video-thumbnail"></video>
          <div class="video-info">
            <p class="video-title">ê¸¸ì´: ${formatTime(video.duration)}</p>
            <p class="video-date">${video.timestamp}</p>
          </div>
          <div class="video-actions">
            <button class="btn btn-small btn-blue" onclick="downloadVideo(${video.id})" title="ë‹¤ìš´ë¡œë“œ">ğŸ’¾</button>
            <button class="btn btn-small btn-red" onclick="deleteVideo(${video.id})" title="ì‚­ì œ">ğŸ—‘ï¸</button>
          </div>
        </div>
      `).join('');
      updateUI();
    }

    // ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
    function downloadVideo(id) {
      const video = state.recordedVideos.find(v => v.id === id);
      if (video) {
        const a = document.createElement('a');
        a.href = video.url;
        a.download = `recording_${video.id}.webm`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
    }

    // ë¹„ë””ì˜¤ ì‚­ì œ
    function deleteVideo(id) {
      const video = state.recordedVideos.find(v => v.id === id);
      if (video) {
        URL.revokeObjectURL(video.url);
      }
      state.recordedVideos = state.recordedVideos.filter(v => v.id !== id);
      renderVideoList();
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    elements.startBtn.addEventListener('click', startRecording);
    elements.pauseBtn.addEventListener('click', pauseRecording);
    elements.resumeBtn.addEventListener('click', resumeRecording);
    elements.stopBtn.addEventListener('click', stopRecording);

    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
      if (state.stream) {
        state.stream.getTracks().forEach(track => track.stop());
      }
      if (state.timer) {
        clearInterval(state.timer);
      }
    });

    // í™”ë©´ ê¹¨ìš°ê¸° ë°©ì§€ (ë…¹í™” ì¤‘)
    let wakeLock = null;
    async function requestWakeLock() {
      try {
        if ('wakeLock' in navigator) {
          wakeLock = await navigator.wakeLock.request('screen');
          console.log('âœ… í™”ë©´ êº¼ì§ ë°©ì§€ í™œì„±í™”');
        }
      } catch (err) {
        console.log('Wake Lock ì˜¤ë¥˜:', err);
      }
    }

    // ë…¹í™” ì‹œì‘ ì‹œ wake lock ìš”ì²­
    const originalStart = startRecording;
    startRecording = async function() {
      await originalStart();
      if (state.isRecording) {
        requestWakeLock();
      }
    };

    // ë…¹í™” ì¤‘ì§€ ì‹œ wake lock í•´ì œ
    const originalStop = stopRecording;
    stopRecording = function() {
      originalStop();
      if (wakeLock) {
        wakeLock.release();
        wakeLock = null;
      }
    };
  </script>
</body>
</html>
